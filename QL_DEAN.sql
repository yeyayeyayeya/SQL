USE MASTER 
CREATE DATABASE QL_DEAN
USE QL_DEAN
GO 

CREATE TABLE PHONGBAN(
TENPHG NVARCHAR(20),
MAPH NCHAR(2) NOT NULL,
TRPHG NCHAR(10),
NG_NHANCHUC DATETIME,
CONSTRAINT PK_PB PRIMARY KEY(MAPH)
)

CREATE TABLE NHANVIEN(
HONV NVARCHAR(30),
TENLOT NVARCHAR(30),
TEN NVARCHAR(30),
MANV NCHAR(10) NOT NULL,
NGSINH DATETIME,
DCHI NVARCHAR(50),
PHAI NVARCHAR(5),
LUONG INT,
MA_NQL NCHAR(10),
PHG NCHAR(2),
CONSTRAINT PK_NV PRIMARY KEY(MANV),
CONSTRAINT FK_NV_PB FOREIGN KEY(PHG) REFERENCES PHONGBAN(MAPH))

CREATE TABLE THANNHAN(
MA_NVIEN NCHAR(10) NOT NULL,
TENTN NVARCHAR(30) NOT NULL,
PHAI NVARCHAR(5),
NGSINH DATETIME,
QUANHE NVARCHAR(15)
CONSTRAINT PK_TN PRIMARY KEY(MA_NVIEN,TENTN),
CONSTRAINT FK_TN_NV FOREIGN KEY(MA_NVIEN) REFERENCES NHANVIEN(MANV)
)

CREATE TABLE DIADIEM_PHG(
MAPHG NCHAR(2) NOT NULL,
DIADIEM NVARCHAR(15) NOT NULL,
CONSTRAINT PK_DD PRIMARY KEY(MAPHG,DIADIEM),
CONSTRAINT FK_DD_PB FOREIGN KEY(MAPHG) REFERENCES PHONGBAN(MAPH))

CREATE TABLE DEAN(
TENDA NVARCHAR(30),
MADA NCHAR(2) NOT NULL,
DDIEM_DA NVARCHAR(15),
PHONG NCHAR(2),
CONSTRAINT PK_DEAN PRIMARY KEY(MADA),
CONSTRAINT FK_PB_DEAN FOREIGN KEY(PHONG,DDIEM_DA) REFERENCES DIADIEM_PHG(MAPHG,DIADIEM))

CREATE TABLE PHANCONG(
MA_NVIEN NCHAR(10) NOT NULL,
SODA NCHAR(2)NOT NULL,
THOIGIAN DECIMAL(10,2),
CONSTRAINT PK_PC PRIMARY KEY(MA_NVIEN, SODA),
CONSTRAINT FK_NV_PC FOREIGN KEY(MA_NVIEN) REFERENCES NHANVIEN(MANV),
CONSTRAINT FK_DA_PC FOREIGN KEY(SODA) REFERENCES DEAN(MADA))

SET DATEFORMAT DMY
INSERT INTO PHONGBAN
VALUES
('Nghien cuu', '5','333445555', '22/05/1978'),
('Dieu hanh', '4', '987987987', '01/01/1985'),
('Quan ly', '1', '888665555', '19/06/1971')

SET DATEFORMAT DMY
INSERT INTO NHANVIEN
VALUES
('Dinh', 'Ba', 'Tien', '123456789', '09/01/1955', '731 Tran Hung Dao, Q1, TPHCM', 'Nam', 30000, '333445555', '5'),
('Nguyen', 'Thanh', 'Tung', '333445555', '08/12/1945', '638 Nguyen Van Cu, Q5, TPHCM', 'Nam', 40000, '888665555', '5'),
('Bui', 'Thuy', 'Vu', '999887777', '19/07/1958', '332 Nguyen Thai Hoc, Q1, TPHCM', 'Nam', 25000, '987654321', '4'),
('Le', 'Thi', 'Nhan', '987654321', '20/06/1931', '291 Ho Van Hue, QPN, TPHCM', 'Nu', 43000, '888665555', '4'),
('Nguyen', 'Manh', 'Hung', '666884444', '15/09/1952', '975 Ba Ria, Vung Tau', 'Nam', 38000, '333445555', '5'),
('Tran', 'Thanh', 'Tam', '453453453', '31/07/1962', '543 Mai Thi Lua, Q1, TPHCM', 'Nam', 25000, '333445555', '5'),
('Tran', 'Hong', 'Quan', '987987987', '29/03/1959', '980 Le Hong Phong, Q10, TPHCM', 'Nam', 25000, '987654321', '4'),
('Vuong', 'Ngoc', 'Quyen', '888665555', '10/10/1927', '450 Trung Vuong, Ha Noi', 'Nu', 55000, null , '1')

SET DATEFORMAT DMY
INSERT INTO THANNHAN
VALUES
('333445555', 'Quang','Nu', '05/04/1976', 'Con gai'),
('333445555', 'Khang','Nam', '25/10/1973', 'Con trai'),
('333445555', 'Duong','Nu', '03/05/1948', 'Vo chong'),
('987654321', 'Dang','Nam', '29/02/1932', 'Vo chong'),
('123456789', 'Duy','Nam', '01/01/1978', 'Con trai'),
('123456789', 'Chau','Nu', '31/12/1978', 'Con gai'),
('123456789', 'Phuong','Nu', '05/05/1957', 'Vo chong')

INSERT INTO DIADIEM_PHG
VALUES
('1', 'TP HCM'),
('4', 'HA NOI'),
('5', 'VUNG TAU'),
('5', 'NHA TRANG'),
('5', 'TP HCM')

INSERT INTO DEAN
VALUES
('San pham X', '1', 'VUNG TAU', '5'),
('San pham Y', '2', 'NHA TRANG', '5'),
('San pham Z', '3', 'TP HCM', '5'),
('Tin hoc hoa', '10', 'HA NOI', '4'),
('Cap quang', '20', 'TP HCM', '1'),
('Dao tao', '30', 'HA NOI', '4')

INSERT INTO PHANCONG
VALUES
('123456789', '1', 32.5),
('123456789', '2', 7.5),
('666884444', '3', 40.0),
('453453453', '1', 20.0),
('453453453', '2', 20.0),
('333445555', '3', 10.0),
('333445555', '10', 10.0),
('333445555', '20', 10.0),
('999887777', '30', 30.0),
('999887777', '10', 10.0),
('987987987', '10', 35.0),
('987987987', '30', 5.0),
('987654321', '30', 20.0),
('987654321', '20', 15.0),
('888665555', '20', NULL)

--1. Danh sách những đề án có: 
--Người tham gia có họ Dinh

SELECT K1.TENDA,K1.MADA, K1.DDIEM_DA, K1.PHONG
FROM DEAN K1
JOIN PHANCONG K2 ON K1.MADA=K2.SODA
JOIN NHANVIEN K3 ON K2.MA_NVIEN=K3.MANV
WHERE HONV ='Dinh'
GROUP BY K1.TENDA,K1.MADA, K1.DDIEM_DA, K1.PHONG

--Có người trưởng phòng chủ trì đề án họ Dinh

SELECT K1.TENDA,K1.MADA, K1.DDIEM_DA, K1.PHONG
FROM DEAN K1
JOIN PHONGBAN K2 ON K1.PHONG=K2.MAPH
JOIN NHANVIEN K3 ON K2.MAPH=k3.PHG
WHERE HONV='Dinh'  
AND K3.MANV=K2.TRPHG
GROUP BY K1.TENDA,K1.MADA, K1.DDIEM_DA, K1.PHONG

--2. Cho biết những nhân viên có cùng tên với người thân
SELECT *
FROM NHANVIEN K1
JOIN THANNHAN K2 ON K1.MANV=K2.MA_NVIEN
WHERE TEN=TENTN
AND MANV=MA_NVIEN

--3. Cho biết những nhân viên không có người thân nào
SELECT *
FROM NHANVIEN K1
WHERE K1.MANV NOT IN (SELECT K2.MA_NVIEN FROM THANNHAN K2)

--4. Cho biết danh sách những nhân viên có 2 thân nhân trở lên
SELECT HONV, TENLOT, TEN, MANV, COUNT(K1.MANV) AS SOTN
FROM NHANVIEN K1
JOIN THANNHAN K2 ON K1.MANV=K2.MA_NVIEN
GROUP BY HONV, TENLOT, TEN, MANV
HAVING COUNT(K1.MANV)>=2
 --5. Cho biết những trưởng phòng có tối thiểu 1 thân nhân
SELECT HONV, TENLOT, TEN, MANV, COUNT(K1.MANV) AS SOTN
FROM NHANVIEN K1
JOIN THANNHAN K3 ON K1.MANV=K3.MA_NVIEN,PHONGBAN K2
WHERE K1.MANV=K2.TRPHG
GROUP BY HONV, TENLOT, TEN, MANV
HAVING COUNT(K1.MANV)>=1

--6. Cho biết những trưởng phòng có mức lương ít hơn(ít nhất một)nhân viên của mình
SELECT HONV, TENLOT, TEN, MANV, COUNT(K1.MANV) AS SOTN
FROM NHANVIEN K1,PHONGBAN K2
WHERE K1.MANV=K2.TRPHG
AND K1.LUONG<ANY(
SELECT LUONG
FROM NHANVIEN K3
JOIN PHONGBAN K4 ON K3.PHG=K4.MAPH
WHERE K3.MANV NOT IN (
SELECT K5.TRPHG
FROM PHONGBAN K5))
GROUP BY HONV, TENLOT, TEN, MANV
--7. Cho biết tên phòng, số lượng nhân viên và tổng lương từng phòng
SELECT TENPHG, COUNT(K1.MANV) AS SONV, 
SUM(LUONG) AS TONGLUONG
FROM NHANVIEN K1
JOIN PHONGBAN K2 ON K1.PHG=K2.MAPH
GROUP BY TENPHG;

--8. Cho biết mã nhân viên (MA_NVIEN) nào có nhiều thân nhân nhất
WITH NV_TN AS(
SELECT MANV, COUNT(K2.MA_NVIEN) AS SOTN
FROM NHANVIEN K1 JOIN THANNHAN K2 ON K1.MANV=K2.MA_NVIEN
GROUP BY MANV)
SELECT *FROM NV_TN
WHERE SOTN= (SELECT MAX(SOTN) FROM NV_TN)

--9. Với mỗi nhân viên, cho biết họ tên nhân viên và số thân nhân của nhân viên
SELECT TEN, COUNT(K2.MA_NVIEN) AS SOTN
FROM NHANVIEN K1
LEFT JOIN THANNHAN K2 ON K1.MANV=K2.MA_NVIEN
GROUP BY TEN

--10. Cho biết lương trung bình của tất cả các nhân viên nữ
SELECT AVG(LUONG) AS LUONGTB
FROM NHANVIEN
WHERE PHAI='Nu'

--11. Cho biết tên của các nhân viên và tên các phòng ban mà họ phụ trách nếu có
SELECT TEN, K2.TENPHG
FROM NHANVIEN K1
LEFT JOIN PHONGBAN K2 ON K1.MANV=k2.TRPHG --kêt bằng manv và mã của trưởng phòng
--12. Cho biết họ tên nhân viên và tên các đề án mà họ tham gia
SELECT K1.HONV, K1.TENLOT, K1.TEN, STRING_AGG(K3.TENDA, ', ') AS TENDA
FROM NHANVIEN K1
JOIN PHANCONG K2 ON K1.MANV=K2.MA_NVIEN
JOIN DEAN K3 ON K2.SODA=K3.MADA
GROUP BY K1.HONV, K1.TENLOT, K1.TEN
--đã có cải tiến gộp các tên đề án của cùng 1 ng vào cùng 1 ô

--13. Cho biết họ tên của trưởng phòng của phòng có đông nhân viên nhất
SELECT TOP 1 K2.HONV, K2.TENLOT, K2.TEN
FROM PHONGBAN K1
JOIN NHANVIEN K2 ON K1.TRPHG = K2.MANV
ORDER BY (SELECT COUNT(*) FROM NHANVIEN WHERE PHG = K1.MAPH) DESC;

--14. Ứng với mỗi phòng, cho biết họ tên nhân viên có mức lương cao nhất

SELECT K1.PHG, K1.HONV, K1.TENLOT, K1.TEN, LUONG
FROM NHANVIEN K1
WHERE LUONG=(
SELECT MAX(LUONG) FROM NHANVIEN K2 WHERE K1.PHG=K2.PHG)

--15. Cho biết nhân viên tham gia tất cả đề án
SELECT K1.MANV, K1.HONV, K1.TENLOT, K1.TEN
FROM NHANVIEN K1
JOIN PHANCONG K2 ON K1.MANV=K2.MA_NVIEN
GROUP BY K1.MANV, K1.HONV, K1.TENLOT, K1.TEN
HAVING COUNT(DISTINCT K2.SODA) = (SELECT COUNT(*) FROM DEAN)

--16. Cho biết nhân viên làm việc cho tất cả đề án mà phòng số 5 chủ trì
SELECT DISTINCT K1.*
FROM NHANVIEN K1
 JOIN PHANCONG K2 ON K1.MANV =K2.MA_NVIEN
 JOIN DEAN K3 ON K2.SODA=K3.MADA
WHERE K3.PHONG='5'

 --17. Cho biết những nhân viên tham gia tất cả đề án mà có nhân viên '987654321' tham gia
SELECT *
FROM NHANVIEN K1
JOIN PHANCONG K2 ON K1.MANV =K2.MA_NVIEN
WHERE K2.SODA=ALL(
SELECT K5.SODA
FROM NHANVIEN K4
JOIN PHANCONG K5 ON K4.MANV =K5.MA_NVIEN
WHERE K4.MANV='987654321')
